<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diet Tracker</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f9f9f9;margin:0;padding:20px;}
    .container{max-width:800px;margin:auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.08);}
    h1,h2{text-align:center;margin:0 0 16px;}
    input,button{width:100%;padding:8px;margin:4px 0;} textarea{width:100%;height:200px;padding:8px;margin:4px 0;resize:vertical;}
    table{width:100%;border-collapse:collapse;margin-top:16px;}
    th,td{border:1px solid #ccc;padding:8px;text-align:left;cursor:default;}
    .tabs{display:flex;gap:4px;margin-bottom:20px;}
    .tabs button{flex:1;padding:10px;border:none;background:#eee;cursor:pointer;}
    .tabs button.active{background:#ddd;border-bottom:2px solid #000;}
    .page{display:none;}
    .page.active{display:block;}
    .totals{font-weight:bold;margin-top:16px;}
    .del-btn{width:auto;padding:4px 8px;cursor:pointer;}
    #saveDayBtn{margin-top:12px;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Diet Tracker</h1>
    <div class="tabs">
      <button data-target="diaryPage" class="tabBtn active">Diary</button>
      <button data-target="foodPage" class="tabBtn">Food List</button>
      <button data-target="historyPage" class="tabBtn">History</button>
      <button data-target="dataPage" class="tabBtn">Data</button>
    </div>

    <!-- Diary Page -->
    <div id="diaryPage" class="page active">
      <h2>Diary for <input type="date" id="diaryDate" /></h2>
      <div>
        <input id="diaryFood" list="foodOptions" placeholder="Food name" />
        <datalist id="foodOptions"></datalist>
        <input id="amount" type="number" placeholder="Amount (g or unit)" />
        <button id="addDiaryBtn">Add to Diary</button>
      </div>
      <table id="diaryTable">
        <thead>
          <tr><th>Food</th><th>Amt</th><th>kJ</th><th>Protein</th><th>Carbs</th><th>Fat</th><th>Delete</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="totals" id="totals">Total: kJ 0 | Protein 0g | Carbs 0g | Fat 0g</div>
      <button id="saveDayBtn">Save Day</button>
    </div>

    <!-- Food Page -->
    <div id="foodPage" class="page">
      <h2>Food Database</h2>
      <form id="foodForm">
        <input id="foodName" placeholder="Food name" required />
        <input id="unit" placeholder="Unit (e.g. 100g, 1 cup)" />
        <input id="kj" type="number" placeholder="Kilojoules (kJ) per unit" />
        <input id="protein" type="number" placeholder="Protein (g) per unit" />
        <input id="carbs" type="number" placeholder="Carbs (g) per unit" />
        <input id="fat" type="number" placeholder="Fat (g) per unit" />
        <button id="addFoodBtn" type="button">Add / Update Food</button>
      </form>
      <table id="foodTable">
        <thead>
          <tr><th>Name</th><th>Unit</th><th>kJ</th><th>Protein</th><th>Carbs</th><th>Fat</th><th>Delete</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- History Page -->
    <div id="historyPage" class="page">
      <h2>Saved Days</h2>
      <table id="historyTable">
        <thead>
          <tr><th>Date</th><th>kJ</th><th>Protein</th><th>Carbs</th><th>Fat</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Data Page -->
    <div id="dataPage" class="page">
      <h2>Data Import / Export</h2>
      <textarea id="dataBox" rows="10" placeholder="Paste data here..."></textarea>
      <button id="exportBtn">Export</button>
      <button id="importBtn">Import</button>
    </div>
  </div>

<script>
(()=>{
  const APP_KEY='dietTracker';
  // Use local timezone to get correct date
  const now = new Date();
  const tzOffset = now.getTimezoneOffset() * 60000;
  const localISO = new Date(now - tzOffset).toISOString().split('T')[0];
  const todayDate = localISO;
  const diaryDateInput = document.getElementById('diaryDate');
  diaryDateInput.value = todayDate;

  const $ = id => document.getElementById(id);
  window.myappdata = window.myappdata || JSON.parse(localStorage.getItem('myappdata')||'{}');
  if (!myappdata[APP_KEY]) myappdata[APP_KEY] = {};

  const saved = myappdata[APP_KEY];
  // Most recently used foods
  if (!saved.mruFoods) saved.mruFoods = [];
  const foodDB = saved.foodDB || {};
  const history = saved.history || {};
  saved.foodDB = foodDB;
  saved.history = history;

  let diaryEntries = [];
  let totals = {kj:0, protein:0, carbs:0, fat:0};

  /* START EXPORTS */
  const computeTotals = entries => entries.reduce((acc,e)=>({kj:acc.kj+e.kj,protein:acc.protein+e.protein,carbs:acc.carbs+e.carbs,fat:acc.fat+e.fat}),{kj:0,protein:0,carbs:0,fat:0});

  const updateMru = (list, name) => {
    const newList = list.filter(n => n !== name);
    newList.unshift(name);
    return newList;
  };

  const persist = () => {
    // include MRU list in storage
    myappdata[APP_KEY] = {foodDB, history, mruFoods: saved.mruFoods};
    localStorage.setItem('myappdata', JSON.stringify(myappdata));
  };

  if (typeof window !== 'undefined') window.DietTrackerExports = {computeTotals, updateMru, persist};
  /* END EXPORTS */

  const loadDiary = (date) => {
    const data = history[date];
    diaryEntries = data ? [...data.entries] : [];
    totals = computeTotals(diaryEntries);
    renderDiaryTable();
    renderTotals();
  };

  diaryDateInput.addEventListener('change',()=>{
    loadDiary(diaryDateInput.value);
  });

  const updateDatalist = () => {
    const dl = $('foodOptions');
    dl.innerHTML = '';
    // prepare sorted list same as food table MRU order
    const entries = Object.keys(foodDB);
    entries.sort((a, b) => {
      const iA = saved.mruFoods.indexOf(a);
      const iB = saved.mruFoods.indexOf(b);
      if (iA !== -1 || iB !== -1) {
        if (iA === -1) return 1;
        if (iB === -1) return -1;
        return iA - iB;
      }
      return a.localeCompare(b);
    });
    entries.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      dl.appendChild(opt);
    });
  };

  const renderTotals = () => {
    $('totals').textContent = `Total: kJ ${totals.kj.toFixed(1)} | Protein ${totals.protein.toFixed(1)}g | Carbs ${totals.carbs.toFixed(1)}g | Fat ${totals.fat.toFixed(1)}g`;
  };

  const renderFoodTable = () => {
    const tbody = $('foodTable').querySelector('tbody'); tbody.innerHTML='';
    // sort foods by MRU first, then alphabetically
    const entries = Object.entries(foodDB).slice();
    entries.sort(([a], [b]) => {
      const iA = saved.mruFoods.indexOf(a);
      const iB = saved.mruFoods.indexOf(b);
      if (iA !== -1 || iB !== -1) return (iA === -1 ? 1 : (iB === -1 ? -1 : iA - iB));
      return a.localeCompare(b);
    });
    entries.forEach(([name,n])=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td class="name-cell" data-name="${name}">${name}</td><td>${n.unit||'100g'}</td><td>${n.kj.toFixed(1)}</td><td>${n.protein.toFixed(1)}</td><td>${n.carbs.toFixed(1)}</td><td>${n.fat.toFixed(1)}</td><td><button class="del-btn" data-name="${encodeURIComponent(name)}">X</button></td>`;
      tbody.appendChild(tr);
    });
  };

  const renderDiaryTable = () => {
    const tbody = $('diaryTable').querySelector('tbody'); tbody.innerHTML='';
    diaryEntries.forEach((e, i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${e.food}</td><td>${e.amount}</td><td>${e.kj.toFixed(1)}</td><td>${e.protein.toFixed(1)}</td><td>${e.carbs.toFixed(1)}</td><td>${e.fat.toFixed(1)}</td><td><button class="del-btn" data-index="${i}">X</button></td>`;
      tbody.appendChild(tr);
    });
  };

  const renderHistoryTable = () => {
    const tbody = $('historyTable').querySelector('tbody');
    tbody.innerHTML = '';
    // Sort dates descending so most recent is first
    Object.entries(history)
      .sort(([dateA], [dateB]) => dateB.localeCompare(dateA))
      .forEach(([date, data]) => {
        const t = data.totals;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${date}</td><td>${t.kj.toFixed(1)}</td><td>${t.protein.toFixed(1)}</td><td>${t.carbs.toFixed(1)}</td><td>${t.fat.toFixed(1)}</td>`;
        tbody.appendChild(tr);
      });
  };

  $('addFoodBtn').addEventListener('click', () => {
    const name = $('foodName').value.trim();
    if (!name) return;
    foodDB[name] = {
      unit: $('unit').value.trim() || '100g',
      kj: parseFloat($('kj').value)||0,
      protein: parseFloat($('protein').value)||0,
      carbs: parseFloat($('carbs').value)||0,
      fat: parseFloat($('fat').value)||0
    };
    persist();
    renderFoodTable(); updateDatalist();
    document.getElementById('foodForm').reset();
  });

  $('foodTable').addEventListener('click', e => {
    if (e.target.classList.contains('del-btn')) {
      const name = decodeURIComponent(e.target.dataset.name);
      delete foodDB[name];
      persist();
      renderFoodTable(); updateDatalist();
    } else if (e.target.classList.contains('name-cell')) {
      const name = e.target.dataset.name;
      const f = foodDB[name];
      $('foodName').value = name;
      $('unit').value = f.unit || '100g';
      $('kj').value = f.kj;
      $('protein').value = f.protein;
      $('carbs').value = f.carbs;
      $('fat').value = f.fat;
    }
  });

  $('addDiaryBtn').addEventListener('click',()=>{
    const name=$('diaryFood').value.trim(); const amt=parseFloat($('amount').value);
    if(!foodDB[name]){alert('Food not in database');return;} if(!amt){alert('Enter amount');return;}
    const f=foodDB[name];
    // determine scaling factor based on unit quantity
    const unitNum = parseFloat(f.unit) || 1;
    const mult = amt / unitNum;
    const entry={food:name,amount:amt,kj:f.kj*mult,protein:f.protein*mult,carbs:f.carbs*mult,fat:f.fat*mult};
    diaryEntries.push(entry);
    totals = computeTotals(diaryEntries);
    renderDiaryTable(); renderTotals();
    // clear input fields
    $('diaryFood').value = '';
    $('amount').value = '';
    // update MRU list
    saved.mruFoods = updateMru(saved.mruFoods, name);
    // persist MRU update
    persist();
  });

  // Diary delete listener
  $('diaryTable').addEventListener('click', e => {
    if (e.target.classList.contains('del-btn')) {
      const idx = parseInt(e.target.dataset.index);
      if (!isNaN(idx)) {
        diaryEntries.splice(idx, 1);
        totals = computeTotals(diaryEntries);
        renderDiaryTable(); renderTotals();
        persist();
      }
    }
  });

  // Save day listener
  $('saveDayBtn').addEventListener('click', () => {
    const day = diaryDateInput.value;
    if (diaryEntries.length === 0) { alert('No entries to save'); return; }
    history[day] = { entries: [...diaryEntries], totals: { ...totals } };
    persist();
    renderHistoryTable();
    alert('Day saved.');
  });

  document.querySelectorAll('.tabBtn').forEach(btn=>btn.addEventListener('click',()=>{
    document.querySelectorAll('.tabBtn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.target).classList.add('active');
  }));

  renderFoodTable(); updateDatalist(); renderHistoryTable();
  // Click on history row to load diary
  document.getElementById('historyTable').addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if (!tr || tr.querySelector('th')) return;
    const date = tr.cells[0].textContent;
    diaryDateInput.value = date;
    loadDiary(date);
    // switch to Diary tab
    document.querySelector('.tabBtn[data-target="diaryPage"]').click();
  });
  loadDiary(todayDate);
  // Data export button
  $('exportBtn')?.addEventListener('click', () => {
    const data = localStorage.getItem('myappdata') || '';
    $('dataBox').value = data;
  });
  // Data import button
  $('importBtn')?.addEventListener('click', () => {
    const text = $('dataBox').value.trim();
    if (!text) { alert('No data to import'); return; }
    let parsedFull;
    try {
      parsedFull = JSON.parse(text);
    } catch(e) {
      alert('Invalid JSON');
      return;
    }
    const newData = parsedFull[APP_KEY] || {};
    // merge into existing storage
    const currentFull = JSON.parse(localStorage.getItem('myappdata') || '{}');
    currentFull[APP_KEY] = newData;
    localStorage.setItem('myappdata', JSON.stringify(currentFull));
    alert('Diet Tracker data imported. Reloading...');
    location.reload();
  });
})();
</script>
</body>
</html>
